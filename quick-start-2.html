<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Command handling - Easy Sourcing</title><meta name="description" content=" Aggregate The very first step is to model our domain. In the following example customer is considered as our aggregate: @Value@Builder(toBuilder = true)@TopicInfo('customer-snapshots')public class&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://alikelleci.github.io/easysourcing/quick-start-2.html"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://alikelleci.github.io/easysourcing/assets/css/style.css?v=54931591f671f61d6ed9cc7eeb94071d"><link rel="stylesheet" href="https://alikelleci.github.io/easysourcing/assets/css/prism-dark.css?v=4cc85e12ca94c0614c9359a37eb69a0c"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://alikelleci.github.io/easysourcing/quick-start-2.html"},"headline":"Command handling","datePublished":"2020-09-28T16:56","dateModified":"2020-10-17T23:00","description":" Aggregate The very first step is to model our domain. In the following example customer is considered as our aggregate: @Value@Builder(toBuilder = true)@TopicInfo(\"customer-snapshots\")public class&hellip;","author":{"@type":"Person","name":"Ali Kelleci"},"publisher":{"@type":"Organization","name":"Ali Kelleci"}}</script></head><body><header class="top"><div class="top__logo"><a class="logo" href="https://alikelleci.github.io/easysourcing/">Easy Sourcing</a></div><div class="top__links"><a href="https://github.com/alikelleci/easysourcing" class="top__links-url" aria-label="Github" title="Github" target="_blank" rel="noopener"><svg height="24" width="24"><use xlink:href="https://alikelleci.github.io/easysourcing/assets/svg/svg-map.svg#github"></use></svg></a></div><button class="navbar__toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button></header><main class="main"><div class="main__left"><div class="main__left-inner"><div class="main__left-content"><article class="post"><header><h1 class="post__title">Command handling</h1></header><div class="post__entry"><h2 id="aggregate">Aggregate</h2><p>The very first step is to model our domain. In the following example customer is considered as our aggregate:<br></p><pre class="line-numbers language-java"><code>@Value
@Builder(toBuilder = true)
@TopicInfo("customer-snapshots")
public class Customer {
  @AggregateId
  private String id;
  private String firstName;
  private String lastName;
  private String address;

  // Getters & setters are generated by Lombok
}
</code></pre><p>Each aggregate is required to have an aggregate identifier annotated with <code>@AggregateId</code>. As without it, EasySourcing will not know to which aggregate a given command is targeted. We also annotate our aggregate with <code>@TopicInfo</code> and specify the destination topic here. Everytime an aggregate updates, a new snapshot will be created in this topic.<br><br>The next step is to create commands and events for our aggregate.</p><p id="commands"><b>Commands</b></p><pre class="line-numbers language-java"><code>@TopicInfo("customer-commands")
public interface CustomerCommand {

  @Value
  @Builder
  class CreateCustomer implements CustomerCommand {
    @AggregateId
    private String customerId;
    private String firstName;
    private String lastName;
  }

  @Value
  @Builder
  class ChangeFirstName implements CustomerCommand {
    @AggregateId
    private String customerId;
    private String firstName;
  }
}</code></pre><p id="events"><b>Events</b></p><pre class="line-numbers language-java"><code>@TopicInfo("customer-events")
public interface CustomerEvent {

  @Value
  @Builder
  class CustomerCreated implements CustomerEvent {
    @AggregateId
    private String customerId;
    private String firstName;
    private String lastName;
  }

  @Value
  @Builder
  class FirstNameChanged implements CustomerEvent {
    @AggregateId
    private String customerId;
    private String firstName;
  }
}</code></pre><p>In the code snippets above, we have created some commands and events for our aggregate. We annotate our target aggregate identifier with <code>@AggregateId</code>. We also annotate our commands and events with <code>@TopicInfo</code> and specifiy the destination topics.</p><p class="msg msg--info">Best practises for choosing topic names:<br></p><ul><li>Choose different topic names for commands and events. .</li><li>Choose different topic names for each aggregate type, for example 'customer-events' and 'order-events'.</li><li>Avoid topic names based on things that change, for example team name, topic owner, service name, product name, and consumer name.</li><li>Avoid topic names based on information that would be stored in other places.</li></ul><h2 id="command-handler">Command handler</h2><p>Now that we have created our commands and events, its time to create a command handler. You can create a command handler by simply annotating your command handling methods with <code>@HandleCommand</code>:</p><pre class="line-numbers language-java"><code>public class CustomerCommandHandler {

  @HandleCommand
  public CustomerEvent handle(Customer currentState, CreateCustomer command) {
    if (currentState != null) {
      throw new ValidationException("Customer already exists.");
    }
    return CustomerCreated.builder()
        .customerId(command.getCustomerId())
        .firstName(command.getFirstName())
        .lastName(command.getLastName())
        .build();
  }

  @HandleCommand
  public CustomerEvent handle(Customer currentState, ChangeFirstName command) {
    if (currentState == null) {
      throw new ValidationException("Customer does not exist,");
    }
    return FirstNameChanged.builder()
        .customerId(command.getCustomerId())
        .firstName(command.getFirstName())
        .build();
  }
}</code></pre><p>The first parameter of the command handling method is the current state of the aggregate. The second parameter is the command that is being handeled. A command handler's responsibility is to validate a command against the current state of the aggregate. If the command is valid, we return one or more events.</p><p class="msg msg--info">Best practises for command handlers:<br></p><ul><li>Command handlers should be pure functions and should not block execution.</li><li>Command handlers should only perform validation checks and return 0..n events.</li><li>Don't call external systems to validate your aggregate. If you need to, then consider if you got your aggregate boundaries correct.</li><li>Don't put logic like sending out emails or updating view models in command handlers. These kind of logic should rather be executed in event handlers.</li></ul><h2 id="aggregator">Aggregator</h2><p>An aggregator applies events to the current state of the aggregate and returns a new updated state. Below we see an example of the customer aggregator:</p><pre class="line-numbers language-java"><code>public class CustomerAggregator {

  @ApplyEvent
  public Customer apply(Customer currentState, CustomerCreated event) {
    return Customer.builder()
        .id(event.getCustomerId())
        .firstName(event.getFirstName())
        .lastName(event.getLastName())
        .build();
  }

  @ApplyEvent
  public Customer apply(Customer currentState, FirstNameChanged event) {
    return currentState.toBuilder()
        .firstName(event.getFirstName())
        .build();
  }
}</code></pre><p>We annotate our aggregating methods with <code>@ApplyEvent</code>. These methods takes two parameters, the first one is the current state of the aggregate and the second parameter is the event to apply. The return value of an aggregator method should always be the <b>type of the aggregate</b>. In this case, we return a new copy of the customer with updated state. Although it is not required to return a new copy, it is recommended that you use immutable objects as much as possible.</p><p class="msg msg--info">Best practises for aggregators:<br></p><ul><li>Aggregators should be pure functions and should not block execution.</li><li>Aggregators should not have any side effects and they should not modify the passed aggregate state. They should rather do a deep copy of the passed aggregate, apply the event and return this altered aggregate.</li></ul><h2 id="dispatching-commands">Dispatching commands</h2><p>Sending commands is as easy as:<br></p><pre class="line-numbers language-java"><code>public class SomeService {

  private CommandGateway commandGateway;

  public void sendCommand() {
    CreateCustomer command = CreateCustomer.builder()
        .customerId("cust-123")
        .firstName("John")
        .lastName("Doe")
        .build();

    commandGateway.send(command);
  }
}
</code></pre><p class="msg msg--info">Spring Boot<br></p><p>When using Spring Boot, you can just autowire an instance of <code>CommandGateway</code>.<br></p></div></article><nav><ul class="posts-nav"><li class="posts-nav__prev"><span>Previous: </span><a href="https://alikelleci.github.io/easysourcing/quick-start.html" class="invert" rel="prev" title="Install">Install</a></li><li class="posts-nav__next"><span>Next: </span><a href="https://alikelleci.github.io/easysourcing/quick-start-3.html" class="invert" rel="next" title="Event handling">Event handling</a></li></ul></nav></div><aside class="main__left-aside"><div class="main__left-aside__inner"><h3>On this page</h3><nav class="aside-toc" id="aside-toc"></nav></div></aside></div></div><div class="main__right"><div class="main__right-inner"><nav class="navbar"><ul class="navbar__menu"><li><a href="https://alikelleci.github.io/easysourcing/introduction.html" target="_self">Introduction</a></li><li class="active-parent has-submenu"><a href="https://alikelleci.github.io/easysourcing/quick-start.html" target="_self" aria-haspopup="true">Quick Start</a><ul class="navbar__submenu" aria-hidden="true"><li><a href="https://alikelleci.github.io/easysourcing/quick-start.html" target="_self">Install</a></li><li class="active"><a href="https://alikelleci.github.io/easysourcing/quick-start-2.html" target="_self">Command Handling</a></li><li><a href="https://alikelleci.github.io/easysourcing/quick-start-3.html" target="_self">Event Handling</a></li></ul></li></ul></nav><div class="footer main__right-footer"><div class="footer__copy">by <a href="https://github.com/alikelleci" target="_blank" rel="nofollow noopener">Ali Kelleci</a></div></div></div></div></main><footer class="footer"><div class="footer__wrap"><div class="footer__inner"><div class="footer__copy">by <a href="https://github.com/alikelleci" target="_blank" rel="nofollow noopener">Ali Kelleci</a></div></div></div></footer><div class="post__progress" id="js-post__progress" aria-hidden="true"></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',        
        submenuWidth: 300,        
        mobileMenuExpandableSubmenus: true,
        isHoverMenu: false,
        ariaButtonAttribute: 'aria-expanded',
   };</script><script src="https://alikelleci.github.io/easysourcing/assets/js/html-contents.min.js?v=169077c370ab8ca62b029845f80f7fd5" defer="defer"></script><script>document.addEventListener("DOMContentLoaded", function(event) {
            htmlContents('#aside-toc', {
                area: '.post__entry',
                top: 2,
                bottom: 3,
                listType: 'o',
                filter: function(arr) {
                    return !arr.matches('.noOutline')
                },
                addIds: true,
                addLinks: true
            });

            setTimeout(function() {
                handleActiveClass('#aside-toc');
            }, 0);
        })</script><script defer="defer" src="https://alikelleci.github.io/easysourcing/assets/js/scripts.min.js?v=2e5cce97094c516b8f7e6af7e7cd3e09"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="https://alikelleci.github.io/easysourcing/assets/js/prism.js?v=277309e26a038bf312a7e8aa239cfbd8"></script><script defer="defer" src="https://alikelleci.github.io/easysourcing/assets/js/prism-line-numbers.min.js?v=13275d3ac10d7028cf6a6f5da276f68c"></script><script defer="defer" src="https://alikelleci.github.io/easysourcing/assets/js/prism-copy-to-clipboard.min.js?v=fabfc3fd9af83cda5208ba2e9f9ed238"></script></body></html>